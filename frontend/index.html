<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Bedrock Chatbot POC</title>
    <style>
      body {
        font-family:
          system-ui,
          -apple-system,
          Segoe UI,
          Roboto,
          Helvetica,
          Arial,
          sans-serif;
        margin: 0;
        background: #0b1220;
        color: #e5e7eb;
      }
      header {
        padding: 12px 16px;
        border-bottom: 1px solid #1f2937;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .container {
        max-width: 900px;
        margin: 0 auto;
        padding: 16px;
      }
      .row {
        display: flex;
        gap: 12px;
        align-items: center;
      }
      input,
      button,
      textarea {
        font-size: 16px;
      }
      input,
      textarea {
        background: #111827;
        color: #e5e7eb;
        border: 1px solid #374151;
        border-radius: 8px;
        padding: 10px;
        width: 100%;
      }
      textarea {
        min-height: 100px;
      }
      button {
        background: #2563eb;
        color: white;
        border: none;
        border-radius: 8px;
        padding: 10px 14px;
        cursor: pointer;
      }
      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .log {
        background: #0b1020;
        border: 1px solid #1f2937;
        padding: 12px;
        border-radius: 8px;
        min-height: 200px;
        white-space: pre-wrap;
      }
      .bubble {
        background: #111827;
        padding: 12px;
        border-radius: 10px;
        margin: 8px 0;
      }
      .you {
        background: #0f172a;
      }
      .meta {
        color: #9ca3af;
        font-size: 12px;
      }
      .row-inline {
        display: flex;
        gap: 8px;
      }
    </style>
  </head>
  <body>
    <header>
      <strong>Bedrock Chatbot POC</strong>
      <span class="meta">paste endpoints in config.json</span>
    </header>
    <div class="container">
      <div class="row-inline">
        <input
          id="rest"
          placeholder="REST endpoint (e.g., https://xxxx.execute-api.region.amazonaws.com/chat)"
        />
        <input id="ws" placeholder="WebSocket endpoint (wss://.../prod)" />
        <button id="save">Save</button>
      </div>
      <p class="meta">
        Session: <span id="sid"></span> • Connection: <span id="cid"></span> • Status:
        <span id="status">disconnected</span>
      </p>

      <div id="messages"></div>
      <textarea id="prompt" placeholder="Write your question..."></textarea>
      <div class="row" style="margin-top: 8px">
        <button id="connect">Connect</button>
        <button id="send" disabled>Send</button>
        <button id="clear">Clear</button>
      </div>
    </div>

    <script>
      const state = { sessionId: Math.random().toString(36).slice(2), connectionId: null, ws: null }
      document.getElementById('sid').textContent = state.sessionId

      // load config if present
      async function loadConfig() {
        try {
          const res = await fetch('config.json', { cache: 'no-store' })
          if (res.ok) {
            const cfg = await res.json()
            document.getElementById('rest').value = cfg.rest || ''
            document.getElementById('ws').value = cfg.ws || ''
          }
        } catch (_) {}
      }
      loadConfig()

      function addBubble(text, who = 'assistant') {
        const el = document.createElement('div')
        el.className = 'bubble ' + (who === 'you' ? 'you' : '')
        el.textContent = text
        document.getElementById('messages').appendChild(el)
        el.scrollIntoView({ behavior: 'smooth', block: 'end' })
        return el
      }

      function setStatus(s) {
        document.getElementById('status').textContent = s
      }

      document.getElementById('save').onclick = async () => {
        const cfg = {
          rest: document.getElementById('rest').value.trim(),
          ws: document.getElementById('ws').value.trim(),
        }
        await fetch('config.json', { method: 'PUT', body: JSON.stringify(cfg) }).catch(() => {})
        alert('Saved locally (if hosted on S3, upload an updated config.json).')
      }

      document.getElementById('connect').onclick = async () => {
        const wsUrl = document.getElementById('ws').value.trim()
        if (!wsUrl) return alert('Provide a WebSocket endpoint')
        if (state.ws)
          try {
            state.ws.close()
          } catch (e) {}
        state.ws = new WebSocket(wsUrl)
        setStatus('connecting')

        state.ws.onopen = () => {
          setStatus('connected')
          // Trigger $default route to send connection-ack reliably
          try {
            state.ws.send(JSON.stringify({ action: 'hello' }))
          } catch (e) {}
          // Keep send disabled until we get the ack with a real connectionId
          document.getElementById('send').disabled = true
        }
        state.ws.onclose = () => {
          setStatus('disconnected')
          document.getElementById('send').disabled = true
          state.connectionId = null
          document.getElementById('cid').textContent = '—'
        }
        state.ws.onmessage = (evt) => {
          try {
            const data = JSON.parse(evt.data)
            const typ = data.event || data.type
            if (typ === 'connection-ack' && data.connectionId) {
              state.connectionId = data.connectionId
              document.getElementById('cid').textContent = data.connectionId
              // Enable send only after we have a valid connectionId
              document.getElementById('send').disabled = false
            } else if (typ === 'delta') {
              if (!state.current) state.current = addBubble('', 'assistant')
              state.current.textContent += data.content
            } else if (typ === 'complete') {
              state.current = null
            }
          } catch (e) {
            // Non-JSON frames ignored
          }
        }
      }

      document.getElementById('send').onclick = async () => {
        const prompt = document.getElementById('prompt').value.trim()
        if (!prompt) return
        addBubble(prompt, 'you')
        document.getElementById('prompt').value = ''

        // REST enqueue
        const rest = document.getElementById('rest').value.trim()
        if (!rest) return alert('Provide a REST endpoint')
        if (
          !state.connectionId ||
          typeof state.connectionId !== 'string' ||
          !state.connectionId.trim()
        ) {
          alert(
            'Waiting for connection to establish. Please try again after the connectionId is received.',
          )
          return
        }
        const payload = {
          prompt,
          sessionId: state.sessionId,
          connectionId: state.connectionId,
        }
        const res = await fetch(rest, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        })
        if (!res.ok) addBubble('Enqueue failed: ' + res.status, 'assistant')
      }

      document.getElementById('clear').onclick = () => {
        document.getElementById('messages').innerHTML = ''
      }
    </script>
  </body>
</html>
